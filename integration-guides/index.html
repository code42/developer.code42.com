
<!doctype html>
<html>
  <head>
      <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-H911T08KR9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-H911T08KR9');
  </script>

    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="../images/favicon-782f3592.ico" rel="icon" type="image/ico" />
    <title>Integration Guides</title>
    <style media="screen">
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s, .highlight .sa, .highlight .dl {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf, .highlight .fm {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv, .highlight .vm {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .nl {
  color: #f92672;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <style media="print">
      * {
        -webkit-transition:none!important;
        transition:none!important;
      }
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #586e75;
}
.highlight .err {
  color: #002b36;
  background-color: #dc322f;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
  color: #657b83;
}
.highlight .cp {
  color: #b58900;
}
.highlight .nt {
  color: #b58900;
}
.highlight .o, .highlight .ow {
  color: #93a1a1;
}
.highlight .p, .highlight .pi {
  color: #93a1a1;
}
.highlight .gi {
  color: #859900;
}
.highlight .gd {
  color: #dc322f;
}
.highlight .gh {
  color: #268bd2;
  background-color: #002b36;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #6c71c4;
}
.highlight .kc {
  color: #cb4b16;
}
.highlight .kt {
  color: #cb4b16;
}
.highlight .kd {
  color: #cb4b16;
}
.highlight .s, .highlight .sa, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #859900;
}
.highlight .sr {
  color: #2aa198;
}
.highlight .si {
  color: #d33682;
}
.highlight .se {
  color: #d33682;
}
.highlight .nn {
  color: #b58900;
}
.highlight .nc {
  color: #b58900;
}
.highlight .no {
  color: #b58900;
}
.highlight .na {
  color: #268bd2;
}
.highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
  color: #859900;
}
.highlight .ss {
  color: #859900;
}
    </style>
    <link href="../stylesheets/screen-7d631313.css" rel="stylesheet" media="screen" />
    <link href="../stylesheets/print-951aa15b.css" rel="stylesheet" media="print" />
    <link rel="stylesheet" href="https://use.typekit.net/sxu2uqu.css">
      <script src="../javascripts/all-0c8f7524.js"></script>

    <script>
      $(function() { setupCodeCopy(); });
    </script>
  </head>

  <body class="integration-guides integration-guides_index" data-languages="[]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="../images/navbar.png" alt="" />
      </span>
    </a>
    <nav class="top-nav">
    <div class="nav-logo">
        <a href="/">
            <img src="../images/logo_developers-300918e0.svg" class="logo" alt="" />
        </a>
    </div>
    <div class="nav-menu">
        <div class="nav-item">
            <a href="https://py42docs.code42.com" target="_blank">Py42</a>
        </div>
        <div class="nav-item">
            <a href="https://clidocs.code42.com" target="_blank">CLI</a>
        </div>
        <div class="nav-item">
            <a href="/integration-guides" target="_blank">Integration Guides</a>
        </div>
        <div class="nav-item">
            <a href="/api">API Reference</a>
        </div>
    </div>
</nav>

    <div class="page-wrapper">
      <div class="content">
        <h1 id='integration-guides'>Integration Guides</h1><h2 id='microsoft-sentinel'>Microsoft Sentinel</h2>
<p>Microsoft Sentinel can accept arbitrary json data as Custom Log sources, so you can ingest almost any type of Incydr
data for querying within Sentinel, including <a href="../api#tag/Alerts/operation/Alerts_QueryAlert">Alerts</a>, <a href="../api#tag/File-Events/operation/searchEventsUsingPOST_1">File Events</a>,
and <a href="../api#tag/Audit-Log/operation/searchAuditLog">Audit Log</a> events.</p>

<p>Sentinel has two methods of ingesting JSON data as Custom Log sources: the data collector HTTP API, and the Log
Analytics Linux agent. While the examples below will focus on Incydr Alerts, the patterns can be re-used for almost any
type of data you can pull from the Code42 API or CLI.</p>
<h3 id='send-incydr-alerts-to-sentinel-with-py42-and-the-azure-monitor-data-collector-api'>Send Incydr Alerts to Sentinel with py42 and the Azure Monitor data collector API</h3>
<p>This guide outlines how to send Incydr Alerts to Sentinel with a Python script using <a href="https://py42docs.code42.com">py42</a>
and the <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/data-collector-api">data collector API</a>.</p>

<details style="margin-left: 30px; margin-right: 60px">
    <summary><b><span style="color: #1976d2;cursor:pointer;">Expand guide</span></b></summary>
    <h3 id='prepare-your-environment'>Prepare your environment:</h3>
<ul>
<li><a href="https://py42docs.code42.com/en/stable/userguides/gettingstarted.html#installation">Install py42 into your Python environment</a></li>
<li><a href="https://support.code42.com/Incydr/Admin/Code42_console_reference/API_clients">Create a Code42 API Client</a> to authenticate py42. The <code>Alerts Read</code> permission is required to query alerts.</li>
<li>Gather your Azure Log Analytics <code>Workspace ID</code> and either <code>Primary Key</code> or <code>Secondary Key</code> to authenticate requests pushing data into Sentinel.</li>
</ul>

<aside style="margin: 30px">
<p style="margin-left: 30px">
<b>NOTE:</b> Workspace ID and Keys can be found in your Log Analytics Workspace Settings under <b>Agents Management</b> > <b>Log Analytics agent instructions</b>.
</aside>
<h3 id='writing-the-script'>Writing the script:</h3>
<p>First, import the py42 SDK client and required classes for building your Alert query:</p>
<div class="highlight"><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">py42.sdk</span>
<span class="kn">from</span> <span class="nn">py42.sdk.queries.alerts.alert_query</span> <span class="kn">import</span> <span class="n">AlertQuery</span>
<span class="kn">from</span> <span class="nn">py42.sdk.queries.alerts.filters</span> <span class="kn">import</span> <span class="n">DateObserved</span>
</code></pre></div>
<p>Then construct your query. This example will search for Alerts created within the past 3 days. See
<a href="https://py42docs.code42.com/en/stable/userguides/searches.html#search-alerts">py42 documentation</a> for details on how
to customize your own query.</p>
<div class="highlight"><pre class="highlight python tab-python"><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="n">date_filter</span> <span class="o">=</span> <span class="n">DateObserved</span><span class="p">.</span><span class="n">on_or_after</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">alert_query</span> <span class="o">=</span> <span class="n">AlertQuery</span><span class="p">(</span><span class="n">date_filter</span><span class="p">)</span>
</code></pre></div>
<aside style="margin: 30px">
<p style="margin-left: 30px">
<b>NOTE:</b> If you are scheduling this script to run regularly, you'll want to store the last retrieved alert's
timestamp to use as the starting point for the next query, so you don't ingest duplicate alerts.
</aside>

<p>Initialize the py42 SDK object with your API client details:</p>
<div class="highlight"><pre class="highlight python tab-python"><code><span class="n">sdk</span> <span class="o">=</span> <span class="n">py42</span><span class="p">.</span><span class="n">sdk</span><span class="p">.</span><span class="n">from_api_client</span><span class="p">(</span>
    <span class="n">host_address</span><span class="o">=</span><span class="s">"https://console.us.code42.com"</span><span class="p">,</span>
    <span class="n">client_id</span><span class="o">=</span><span class="s">"&lt;your_client_id&gt;"</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="s">"&lt;your_secret&gt;"</span>
<span class="p">)</span>
</code></pre></div>
<p>Fetch the alerts with your query:</p>
<div class="highlight"><pre class="highlight python tab-python"><code><span class="n">response</span> <span class="o">=</span> <span class="n">sdk</span><span class="p">.</span><span class="n">alerts</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</code></pre></div>
<aside style="margin: 30px">
<p style="margin-left: 30px">
<b>NOTE:</b> If you anticipate needing to ingest a large number of alerts, you may want to use the
<a href=https://py42docs.code42.com/en/stable/methoddocs/alerts.html#py42.clients.alerts.AlertsClient.search_all_pages>search_all_pages()</a>
method, which will yield a generator of pages that you can iterate over to get all the results in a single call.
</aside>

<p>The Sentinel HTTP endpoint accepts a list of JSON objects in the request body, to prepare the py42 response for sending
to Sentinel, you just need to extract the <code>alerts</code> data from the py42 response and convert it to a JSON string:</p>
<div class="highlight"><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">json</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">sdk</span><span class="p">.</span><span class="n">alerts</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="s">"alerts"</span><span class="p">])</span>
</code></pre></div>
<p>Then we can use the <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/data-collector-api#python-sample">Python example</a>
from the Data Collector API documentation to authenticate and send the Incydr Alerts to Sentinel. The example is
recreated here with the py42 code replacing the example data:</p>
<div class="highlight"><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="kn">import</span> <span class="nn">py42.sdk</span>
<span class="kn">from</span> <span class="nn">py42.sdk.queries.alerts.alert_query</span> <span class="kn">import</span> <span class="n">AlertQuery</span>
<span class="kn">from</span> <span class="nn">py42.sdk.queries.alerts.filters</span> <span class="kn">import</span> <span class="n">DateObserved</span>

<span class="c1"># Update the customer ID to your Log Analytics workspace ID
</span><span class="n">customer_id</span> <span class="o">=</span> <span class="s">'xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'</span>

<span class="c1"># For the shared key, use either the primary or the secondary Connected Sources client authentication key
</span><span class="n">shared_key</span> <span class="o">=</span> <span class="s">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>

<span class="c1"># This creates a new Custom Log type for Incydr Alerts
</span><span class="n">log_type</span> <span class="o">=</span> <span class="s">'IncydrAlert'</span>


<span class="c1">#####################
##Incydr Alert Query#
#####################
</span>
<span class="n">date_filter</span> <span class="o">=</span> <span class="n">DateObserved</span><span class="p">.</span><span class="n">on_or_after</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">alert_query</span> <span class="o">=</span> <span class="n">AlertQuery</span><span class="p">(</span><span class="n">date_filter</span><span class="p">)</span>

<span class="n">sdk</span> <span class="o">=</span> <span class="n">py42</span><span class="p">.</span><span class="n">sdk</span><span class="p">.</span><span class="n">from_api_client</span><span class="p">(</span>
    <span class="n">host_address</span><span class="o">=</span><span class="s">"https://console.us.code42.com"</span><span class="p">,</span>
    <span class="n">client_id</span><span class="o">=</span><span class="s">"&lt;your_client_id&gt;"</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="s">"&lt;your_secret&gt;"</span>
<span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">sdk</span><span class="p">.</span><span class="n">alerts</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="s">"alerts"</span><span class="p">])</span>

<span class="c1">#####################
##Sentinel Functions#
#####################
</span>
<span class="c1"># Build the API signature
</span><span class="k">def</span> <span class="nf">build_signature</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">shared_key</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
    <span class="n">x_headers</span> <span class="o">=</span> <span class="s">'x-ms-date:'</span> <span class="o">+</span> <span class="n">date</span>
    <span class="n">string_to_hash</span> <span class="o">=</span> <span class="n">method</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">content_type</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">x_headers</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">resource</span>
    <span class="n">bytes_to_hash</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">string_to_hash</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">)</span>
    <span class="n">decoded_key</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">shared_key</span><span class="p">)</span>
    <span class="n">encoded_hash</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">hmac</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">decoded_key</span><span class="p">,</span> <span class="n">bytes_to_hash</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">).</span><span class="n">digest</span><span class="p">()).</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">authorization</span> <span class="o">=</span> <span class="s">"SharedKey {}:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="n">encoded_hash</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">authorization</span>

<span class="c1"># Build and send a request to the POST API
</span><span class="k">def</span> <span class="nf">post_data</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">shared_key</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">log_type</span><span class="p">):</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s">'POST'</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="s">'application/json'</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="s">'/api/logs'</span>
    <span class="n">rfc1123date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%a, %d %b %Y %H:%M:%S GMT'</span><span class="p">)</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">build_signature</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">shared_key</span><span class="p">,</span> <span class="n">rfc1123date</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">customer_id</span> <span class="o">+</span> <span class="s">'.ods.opinsights.azure.com'</span> <span class="o">+</span> <span class="n">resource</span> <span class="o">+</span> <span class="s">'?api-version=2016-04-01'</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'content-type'</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
        <span class="s">'Authorization'</span><span class="p">:</span> <span class="n">signature</span><span class="p">,</span>
        <span class="s">'Log-Type'</span><span class="p">:</span> <span class="n">log_type</span><span class="p">,</span>
        <span class="s">'x-ms-date'</span><span class="p">:</span> <span class="n">rfc1123date</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">&lt;=</span> <span class="mi">299</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Accepted'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Response code: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">))</span>

<span class="n">post_data</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">shared_key</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">log_type</span><span class="p">)</span>
</code></pre></div>
<p>After the script is run, you should be able to query the <code>IncydrAlert_CL</code> log table and see the Incydr Alert data.</p>

</details>
<h3 id='send-incydr-alerts-to-sentinel-with-the-code42-cli-and-the-azure-log-analytics-linux-agent'>Send Incydr Alerts to Sentinel with the Code42 CLI and the Azure Log Analytics Linux agent</h3>
<p>This guide outlines how to configure a <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/data-sources-json">custom JSON source for ingest using the Azure Log Analytics agent</a>
The <a href="https://clidocs.code42.com/en/stable/">Code42 CLI</a> can then be installed on the same machine to fetch alerts
periodically using the Log Analytics agent configuration.</p>

<details style="margin-left: 30px; margin-right: 60px">
    <summary><b><span style="color: #1976d2;cursor:pointer;">Expand guide</span></b></summary>
    <h3 id='prepare-your-environment'>Prepare your environment:</h3>
<ul>
<li>Install the <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/log-analytics-agent">Azure Log Analytics Agent</a></li>
<li>Install the <a href="https://clidocs.code42.com/en/stable/userguides/gettingstarted.html">Code42 CLI</a></li>
<li>Configure a Code42 CLI <a href="https://clidocs.code42.com/en/stable/userguides/profile.html">profile</a> for the <code>omsagent</code> user:

<ol>
<li>Become the <code>omsagent</code> user: <code>sudo su omsagent</code></li>
<li>Create a new Code42 CLI profile: <code>code42 profile create-api-client --name sentinel --server &lt;code42_console_domain&gt; --api-client-id &lt;your_id&gt; --secret &lt;your_secret&gt;</code></li>
<li>Test the command you&#39;ll be using to ingest Inycdr data, for example: <code>code42 alerts search --begin 3d --format raw-json</code></li>
</ol></li>
</ul>

<aside style="margin: 30px">
<p style="margin-left: 30px">
<b>NOTE:</b> The Code42 CLI will use the <a href=https://keyring.readthedocs.io>keyring</a> python library to store the
API client secret. If the profile creation command prompts <code>Please enter password for encrypted keyring:</code>,
then the default keyring store is an encrypted file, which requires a password on every invocation. To store the secret
in a plaintext flat file run the following commands as the <code>omsagent</code> user:<br>
    - <code>mkdir -p $HOME/.local/share/python_keyring</code><br>
    - <code>echo -e '[backend]\ndefault-keyring=keyrings.alt.file.PlaintextKeyring\n' > $HOME/.local/share/python_keyring/keyringrc.cfg</code>
</aside>
<h3 id='configure-the-log-analytics-agent-omsagent'>Configure the Log Analytics Agent (<code>omsagent</code>)</h3>
<p>Following the steps from <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/data-sources-json">Azure Documentation</a>,
below is an example config that ingests Incydr Alerts using the Code42 CLI. The configuration examples can be added to
<code>/etc/opt/microsoft/omsagent/&lt;workspace id&gt;/conf/omsagent.conf</code> or in their own separate file in the
<code>/etc/opt/microsoft/omsagent/&lt;workspace id&gt;/conf/omsagent.d/</code> folder.</p>
<h4 id='the-input-configuration'>The input configuration</h4><div class="highlight"><pre class="highlight plaintext"><code>&lt;source&gt;
  type exec
  command code42 alerts search -b 1d --format raw-json --checkpoint sentinel
  format json
  tag oms.api.incydr
  run_interval 1h
&lt;/source&gt;
</code></pre></div>
<p>The <code>code42</code> command has two important options, the <code>--format raw-json</code> output causes the CLI to write each Alert JSON
object to stdout on its own line, and the <code>--checkpoint sentinel</code> option tells the CLI to store the last retrieved alert
timestamp in the CLI profile, and subsequent runs will use that checkpoint date as the starting point for the next query.
This prevents duplicate alerts from being ingested, as the query will only search for alerts <em>after</em> the last seen one.</p>

<p>The <code>tag</code> config value defines what Custom Log table the events will be written to. Whatever is after <code>oms.api.</code> in the
tag will become a new Custom Log table (in this example the table name becomes <code>incydr_CL</code>).</p>
<h4 id='the-output-configuration'>The output configuration</h4><div class="highlight"><pre class="highlight plaintext"><code>&lt;match oms.api.incydr&gt;
  type out_oms_api
  log_level info

  buffer_chunk_limit 5m
  buffer_type file
  buffer_path /var/opt/microsoft/omsagent/&lt;workspace id&gt;/state/out_oms_api_incydr*.buffer
  buffer_queue_limit 10
  flush_interval 20s
  retry_limit 10
  retry_wait 30s
&lt;/match&gt;
</code></pre></div>
<p>Once the configuration is saved, restart the <code>omsagent</code> by running: <code>/opt/microsoft/omsagent/bin/service_control restart</code>.</p>

<p>You should start seeing Incydr alerts being populated in the <code>incydr_CL</code> table shortly.</p>

<p>For issues troubleshooting ingest using the Log Analytics agent, see <a href="https://github.com/microsoft/OMS-Agent-for-Linux/blob/master/docs/Troubleshooting.md">Microsoft&#39;s Troubleshooting FAQ</a>.</p>

</details>

      </div>
    </div>
    <footer>
      © 2022 Code42 Software, Inc. All Rights Reserved.
      <a href="https://www.code42.com/terms-of-use/" target="_blank">Terms of use</a>
      <a href="https://www.code42.com/privacy/" target="_blank">Privacy statement</a>
    </footer>
  </body>
</html>
